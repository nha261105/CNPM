pipeline {
    agent any

    // 1. QUAN TRỌNG: Khai báo tool để Jenkins dùng được lệnh 'npm'
    // Đảm bảo bạn đã vào Manage Jenkins -> Tools -> NodeJS và đặt tên là "NodeJS 18" (hoặc version bạn cài)
    tools {
        nodejs 'NodeJS 18' 
    }

    options {
        timeout(time: 30, unit: 'MINUTES') // Giảm time out xuống cho hợp lý
    }

    environment {
        // Lấy ngày giờ build để log cho đẹp
        BUILD_DATE = sh(script: "date +%Y-%m-%d_%H-%M-%S", returnStdout: true).trim()
    }

    stages {
        // Giai đoạn 1: Kiểm tra môi trường cơ bản
        stage('Environment Check') {
            steps {
                echo 'Checking environment prerequisites...'
                // Chỉ cần kiểm tra Node và NPM là đủ cho quy trình này
                sh 'node --version'
                sh 'npm --version'
                echo 'Environment check passed.'
            }
        }

        // Giai đoạn 2: Lấy code về
        stage('Checkout') {
            steps {
                checkout scm
                echo "Branch: ${env.BRANCH_NAME ?: 'main'} | Build: ${env.BUILD_NUMBER} | ${env.BUILD_DATE}"
            }
        }

        // Giai đoạn 3: Cài đặt thư viện và Test (CI)
        stage('Build & Test & Lint') {
            parallel {
                stage('Backend CI') {
                    steps {
                        dir('backend') {
                            echo '--- Backend: Install & Test ---'
                            sh 'npm ci || npm install' // Cài thư viện
                            // Chạy test nếu có (bỏ comment nếu dự án đã có test)
                            // sh 'npm test' 
                            
                            echo '--- Backend: Lint Check ---'
                            // Chạy lint nhưng không chặn pipeline nếu lỗi (non-blocking)
                            sh 'npm run lint || echo "Backend lint warnings ignored"'
                        }
                    }
                }
                stage('Frontend CI') {
                    steps {
                        dir('frontend') {
                            echo '--- Frontend: Install & Test ---'
                            sh 'npm ci || npm install'
                            // sh 'npm test'
                            
                            echo '--- Frontend: Lint Check ---'
                            sh 'npm run lint || echo "Frontend lint warnings ignored"'
                        }
                    }
                }
            }
        }

        // Giai đoạn 4: Hỏi ý kiến trước khi Deploy (Chỉ chạy trên nhánh main)
        stage('Production Approval') {
            when { branch 'main' }
            steps {
                script {
                    // Timeout 15 phút chờ bấm nút
                    timeout(time: 15, unit: 'MINUTES') {
                        // Bỏ 'submitter: admin' để user nào có quyền build cũng bấm được
                        input message: 'Tests passed. Deploy to Production (Vercel & Render)?', ok: 'Deploy Now'
                    }
                }
            }
        }

        // Giai đoạn 5: Kích hoạt Deploy (CD)
        stage('Trigger Deployments') {
            when { branch 'main' }
            parallel {
                stage('Trigger Vercel (FE)') {
                    steps {
                        echo 'Triggering Vercel deploy hook...'
                        withCredentials([string(credentialsId: 'VERCEL_DEPLOY_HOOK', variable: 'VERCEL_HOOK')]) {
                            sh '''
                                curl -X POST "${VERCEL_HOOK}"
                                echo " -> Vercel trigger sent!"
                            '''
                        }
                    }
                }

                stage('Trigger Render (BE)') {
                    steps {
                        echo 'Triggering Render deploy hook...'
                        withCredentials([string(credentialsId: 'RENDER_DEPLOY_HOOK', variable: 'RENDER_HOOK')]) {
                            sh '''
                                curl "${RENDER_HOOK}"
                                echo " -> Render trigger sent!"
                            '''
                        }
                    }
                }
            }
        }
    }

    post {
        success { 
            echo "✅ Pipeline Success! Deployment triggered." 
        }
        failure { 
            echo "❌ Pipeline Failed! Please check logs." 
        }
        always {
            echo "Cleaning workspace..."
            cleanWs() // Dọn dẹp file rác sau khi chạy xong
        }
    }
}