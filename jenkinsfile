pipeline {
    agent any

    options {
        timeout(time: 45, unit: 'MINUTES') // Optimized timeout
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipDefaultCheckout(false)
        retry(2) // Auto-retry failed builds
    }

    environment {
        BUILD_DATE = sh(script: "date +%Y-%m-%d_%H-%M-%S", returnStdout: true).trim()
        NODE_VERSION = '22.x'
        // Performance optimizations
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
        NODE_ENV = 'development'
        NEXT_TELEMETRY_DISABLED = '1'
        // Cache optimization
        NPM_CONFIG_CACHE = '/tmp/npm-cache'
        NPM_CONFIG_PREFER_OFFLINE = 'true'
    }

    stages {
        // stage('Environment Check') {
        //     steps {
        //         echo 'Checking environment prerequisites...'
        //         sh 'docker --version || (echo "Docker not installed!" && exit 1)'
        //         sh 'docker compose version || (echo "Docker Compose not installed!" && exit 1)'
        //         sh '[ -x scripts/deploy-dev.sh ] || (echo "scripts/deploy-dev.sh is not executable!" && exit 1)'
        //         sh '[ -x scripts/deploy-staging.sh ] || (echo "scripts/deploy-staging.sh is not executable!" && exit 1)'
        //         sh '[ -x scripts/deploy-prod.sh ] || (echo "scripts/deploy-prod.sh is not executable!" && exit 1)'
        //         sh '[ -f docker-compose.dev.yml ] || (echo "docker-compose.dev.yml missing!" && exit 1)'
        //     // sh '[ -f docker-compose.prod.yml ] || (echo "docker-compose.prod.yml missing!" && exit 1)'
        //         script {
        //             try {
        //                 withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
        //                     echo 'DockerHub credentials found.'
        //                 }
        //             } catch (e) {
        //                 echo 'DockerHub credentials not configured (non-blocking if you do not push images).'
        //             }
        //         }
        //         echo 'Environment check passed.'
        //     }
        // }

        stage('Checkout') {
            steps {
                checkout scm
                echo "Branch: ${env.BRANCH_NAME ?: 'main'} | Build: ${env.BUILD_NUMBER} | ${env.BUILD_DATE}"
            }
        }

        stage('Build & Test') {
            parallel {
                stage('Backend') {
                    steps {
                        dir('backend') {
                            echo 'C√†i ƒë·∫∑t v√† ki·ªÉm tra backend (ch·ªâ lint/test, cache node_modules)'
                            sh '''
                                npm ci --cache $NPM_CONFIG_CACHE --prefer-offline --no-audit --no-fund || npm install
                                npm run lint || true
                                npm run test || true
                            '''
                        }
                    }
                }
                stage('Frontend') {
                    steps {
                        dir('frontend') {
                            echo 'C√†i ƒë·∫∑t v√† ki·ªÉm tra frontend (ch·ªâ lint/test, cache node_modules)'
                            sh '''
                                npm ci --cache $NPM_CONFIG_CACHE --prefer-offline --no-audit --no-fund || npm install
                                npm run lint || true
                                npm run test || true
                            '''
                        }
                    }
                }
            }
        }

    // stage('Code Quality Check') {
    //     parallel {
    //         stage('Lint Backend') {
    //             steps {
    //                 dir('backend') {
    //                     sh 'npm run lint || echo "Backend linting issues found (non-blocking)"'
    //                 }
    //             }
    //         }
    //         stage('Lint Frontend') {
    //             steps {
    //                 dir('frontend') {
    //                     sh 'npm run lint || echo "Frontend linting issues found (non-blocking)"'
    //                 }
    //             }
    //         }
    //     }
    // }

    // stage('Security Scan') {
    //     steps {
    //         dir('backend') { sh 'npm audit --audit-level=high || true' }
    //         dir('frontend') { sh 'npm audit --audit-level=high || true' }
    //     }
    // }

    // stage('Build Docker Images') {
    //     steps {
    //         script {
    //             parallel (
    //                 "Backend Image": {
    //                     sh '''
    //                         echo "üèóÔ∏è Building backend Docker image..."
    //                         docker build \
    //                             --cache-from smartbus-backend:latest \
    //                             --build-arg BUILDKIT_INLINE_CACHE=1 \
    //                             -t smartbus-backend:latest \
    //                             -t smartbus-backend:${BUILD_NUMBER} \
    //                             -f backend/Dockerfile.dev ./backend
    //                     '''
    //                 },
    //                 "Frontend Image": {
    //                     sh '''
    //                         echo "üèóÔ∏è Building frontend Docker image..."
    //                         docker build \
    //                             --cache-from smartbus-frontend:latest \
    //                             --build-arg BUILDKIT_INLINE_CACHE=1 \
    //                             -t smartbus-frontend:latest \
    //                             -t smartbus-frontend:${BUILD_NUMBER} \
    //                             -f frontend/Dockerfile.dev ./frontend
    //                     '''
    //                 }
    //             )
    //             echo "‚úÖ All Docker images built successfully"
    //         }
    //     }
    // }

    // stage('Push Docker Images') {
    //     // Always run this stage
    //     steps {
    //         script {
    //             withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
    //                 sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
    //                 sh 'docker tag smartbus-backend:latest $DOCKER_USER/smartbus-backend:latest'
    //                 sh 'docker tag smartbus-frontend:latest $DOCKER_USER/smartbus-frontend:latest'
    //                 sh 'docker push $DOCKER_USER/smartbus-backend:latest'
    //                 sh 'docker push $DOCKER_USER/smartbus-frontend:latest'
    //             }
    //         }
    //     }
    // }

        stage('Deploy to Development') {
            steps { 
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        try {
                            sh '''
                                echo "üöÄ Starting development deployment..."
                                bash scripts/deploy-dev.sh
                            '''
                            echo "‚úÖ Development deployment completed successfully!"
                        } catch (Exception e) {
                            echo "‚ùå Development deployment failed: ${e.getMessage()}"
                            // Show container logs for debugging
                            sh 'docker compose -f docker-compose.dev.yml logs --tail=50 || true'
                            throw e
                        }
                    }
                }
            }
        }

    // stage('Deploy to Staging') {
    //     // Always run this stage
    //     steps { sh 'bash scripts/deploy-staging.sh' }
    // }

    stage('Deploy Frontend (Vercel)') {
        // Always run this stage
        steps {
                        echo 'B·∫Øt ƒë·∫ßu g·ªçi Vercel deploy hook...'
                        sh '''
set -euo pipefail
# G·ªçi hook Vercel t·ªëi ƒëa 3 l·∫ßn n·∫øu th·∫•t b·∫°i
for i in 1 2 3; do
    echo "Vercel hook POST attempt #$i ..."
    HTTP_CODE=$(curl -s -o /tmp/vercel_resp.json -w "%{http_code}" -X POST "https://api.vercel.com/v1/integrations/deploy/prj_clKk0bSXKxWNDvdaiCTiTstGTVPS/YCJaNRda40")
    cat /tmp/vercel_resp.json || true
    echo "Vercel HTTP status: $HTTP_CODE"
    if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
        echo "Vercel deploy hook th√†nh c√¥ng."
        break
    fi
    if [ "$i" -eq 3 ]; then
        echo "Vercel deploy hook th·∫•t b·∫°i sau 3 l·∫ßn th·ª≠."
        exit 1
    fi
    sleep $((i * 5))
done
'''
        }
    }

        // C√°c stage duy·ªát production v√† deploy production ƒë√£ ƒë∆∞·ª£c comment l·∫°i ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô pipeline
    // }

    // stage('Smoke Tests') {
    //     when { branch 'main' }
    //     steps {
    //         echo 'Running smoke tests...'
    //         sh '''
    //             sleep 10
    //             # Customize these URLs for your real endpoints:
    //             # curl -f http://localhost:3000/ || echo "FE not ready"
    //             # curl -f https://your-backend.example.com/health || echo "BE not ready"
    //             echo "Smoke tests skipped by default (customize Jenkinsfile)."
    //         '''
    //     }
    // }
    }

    post {
        success { echo "Pipeline finished OK." }
        failure { echo "Pipeline failed ‚Äî check console output." }
        always {
            echo "Cleaning workspace..."
            cleanWs()
        }
    }
}
